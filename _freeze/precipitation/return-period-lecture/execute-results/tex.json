{
  "hash": "2fd64c32a51fef83d7ce22567c17b48b",
  "result": {
    "markdown": "---\ntitle: Return Period\nexecute:\n  freeze: auto\n---\n\n## Bilbao, Spain\n\n![](/archive/figures/bilbao-map.png)\n\n## Today\n\n![](https://upload.wikimedia.org/wikipedia/commons/9/90/Guggenheim_museum_Bilbao_HDR-image.jpg)\n\n## August 1983\n\n![](/archive/figures/bilbao-flood-cars.jpg)\n\nOn Friday, August 26, 1983, Bilbao was celebrating its Aste Nagusia or Great Week, the main annual festivity in the city, when it and other municipalities of the Basque Country, Burgos, and Cantabria suffered devastating flooding due to heavy rains. In 24 hours, the volume of water registered 600 liters per square meter. Across all the affected areas, the weather service recorded 1.5 billion tons of water. In areas of Bilbao, the water reached a height of 5 meters (15 feet). Transportation, electricity and gas services, drinking water, food, telephone, and many other basic services were severely affected. 32 people died in Biscay, 4 people died in Cantabria, 2 people died in Alava, and 2 people died Burgos. 5 more people went missing.\n\n## How often will such rainfall happen?\n\nHow often does it rain 50 mm in 1 day? What about 100 mm in 1 day? How big is a \"once-in-a-century event\"?\n\nLet's examine Bilbao's daily rainfall (mm), between 1947 to 2021\n\n![](/archive/figures/bilbao-1947-2021.png)\n\nOn the week of 22-28 August 1983, Bilbao's weather station measured 4.5 m of rainfall!\n\n![](/archive/figures/bilbao-august-1983.png)\n\nLet's analyze this data and find out how rare such events are. First we need to find the annual maximum for each hydrological year.\n\n::: {.cell execution_count=1}\n``` {.python .cell-code code-fold=\"true\" code-summary=\"Show/hide the code\"}\nimport matplotlib.pyplot as plt\nimport numpy as np\nimport pandas as pd\n\ndf = pd.read_csv('BILBAO_daily.csv', sep=\",\")\ndf['DATE'] = pd.to_datetime(df['DATE'])\ndf = df.set_index('DATE')\n# IMPORTANT!! daily precipitation data is in tenths of mm, divide by 10 to get it in mm.\ndf['PRCP'] = df['PRCP'] / 10\n\nimport altair as alt\nalt.data_transformers.disable_max_rows()\n\n# Altair only recognizes column data; it ignores index values.\n# You can plot the index data by first resetting the index\n# I know that I've just made 'DATE' the index, but I want to have this here nonetheless so I can refer to this in the future\ndf_new = df.reset_index()#.replace({0.0:np.nan})\nsource = df_new[['DATE', 'PRCP']]\n\nbrush = alt.selection(type='interval', encodings=['x'])\n\nbase = alt.Chart(source).mark_line().encode(\n    x = 'DATE:T',\n    y = 'PRCP:Q'\n).properties(\n    width=600,\n    height=200\n)\n\nupper = base.encode(\n    alt.X('DATE:T', scale=alt.Scale(domain=brush)),\n    alt.Y('PRCP:Q', scale=alt.Scale(domain=(0,100)))\n)\n\nlower = base.properties(\n    height=60\n).add_selection(brush)\n\nalt.vconcat(upper, lower)\n```\n\n::: {.cell-output .cell-output-display execution_count=1}\n```\nalt.VConcatChart(...)\n```\n:::\n:::\n\n\nWe will consider a hydrological year starting on 1 August.\n![](/archive/figures/monthly_average_bilbao.png)\n\nHistogram of annual maximum events\n![](/archive/figures/hist_count_cumulative_bilbao.png)\n\n![](/archive/figures/pdf_cdf_bilbao.png)\n\nHow many years, **on average**, do we have to wait to get an annual maximum above a given threshold?\n\n![](/archive/figures/return_prob_050.png)\n\n![](/archive/figures/return_prob_033.png)\n\n![](/archive/figures/return_prob_020.png)\n\n![](/archive/figures/return_prob_010.png)\n\n![](/archive/figures/return_prob_005.png)\n\nNow everything together in one gif:\n\n![](/archive/figures/return_prob.gif)\n\n## Return Period\n\nWe will follow @brutsaert2005hydrology, page 513. He defines quantities a little different from what we did above.\n\n$F(x)$ is the CDF of the PDF $f(x)$. $F(x)$ indicates the non-exceedance probability, i.e., the probability that a certain event above $x$ has **not** occurred (or that an event below $x$ has occurred, same thing). Modifying the graph shown above, we have\n\n![](/archive/figures/return_prob_050_reversed.png)\n\n\n$1-F(x)$ is the probability that a certain event above $x$ *has* occurred. It's reciprocal is the return period:\n\n$$\nT_r(x) = \\frac{1}{1-F(x)}\n$$\n\nThis return period is the expected number of observations required until $x$ is exceeded once.\nIn our case, we can ask the question: how many years will pass (on average) until we see a rainfall event greater that that of 26 August 1983?\n\nLet's call $p=F(x)$ the probability that we measured once and that an event greater than $x$ has *not* occurred.\nWhat is the probability that a rainfall above $x$ will occur only on year number $k$?  \n* it hasn't occurred on year 1 (probability p)\n* it hasn't occurred on year 2 (probability p)\n* it hasn't occurred on year 3 (probability p)\n* ...\n* it has occurred on year k (probability 1-p)\n\n$P\\{k \\text{ trials until }X>x\\} = p^{k-1}(1-p)$\n\nEvery time the number $k$ will be different. What will be $k$ *on average*?\n\n$$\\bar{k} = \\displaystyle\\sum_{k=1}^{\\infty} k P(k) = \\displaystyle\\sum_{k=1}^{\\infty} k p^{k-1}(1-p)$$\n\nLet's open that up:\n\n$$\n\\begin{align}\n\\bar{k} &= 1-p + 2p(1-p) + 3p^2(1-p) + 4p^3(1-p)+ \\cdots\\\\\n\\bar{k} &= 1-p + 2p - 2p^2 + 3p^2 - 3p^4 + 4p^3 - 4p^4+ \\cdots \\\\\n\\bar{k} &= 1 + p + p^2 + p^3 + p^4 + \\cdots\n\\end{align}\n$$\n\nFor $p<1$, the series converges to\n$$\n1 + p + p^2 + p^3 + p^4 + \\cdots = \\frac{1}{1-p},\n$$\ntherefore\n$$\n\\bar{k} = \\frac{1}{1-p}.\n$$\n\nWe conclude that if we know the exceedance probability, we immediately can say what the return times are. We now need a way of estimating this exceedance probability.\n\n## Plotting Position\n\nSource: @brutsaert2005hydrology, pages 514-516  \n\nThe **Plotting Position** is used as an estimate of the exceedance probability. Many formulas have been suggested (see source above), we will use the **Weibull plotting position**:\n\n$P_m=$ plotting position, or probability of occurence for each event  \n$n=$ total number of events  \n$m=$ rank of each event, where $m=1$ is the lowest value, and $m=n$ is the highest\n\n\n### Return period\n$$\n\\text{Return period} = T_r = \\frac{1}{1-P_m}\n$$\n\n#### Weibull plotting position:\n\n$$\nP_m = \\frac{m}{n+1}\n$$\n\nNow let's calculate that for Bilbao:\n\n::: {.cell execution_count=2}\n``` {.python .cell-code code-fold=\"true\" code-summary=\"Show/hide the code\"}\n# resample daily data into yearly data (maximum yearly value)\nmax_annual = df['PRCP'].resample('A-JUL').max().to_frame()\n# sort yearly max from lowest to highest\nmax_annual = max_annual.sort_values(by=['PRCP'], ascending=True)\nmax_annual['m'] = np.arange(1, len(max_annual) + 1)\nn = len(max_annual['m'])\nmax_annual['Pm'] = max_annual['m'] / (n+1)\nmax_annual['Tr'] = 1 / (1 - max_annual['Pm'])\nmax_annual\n```\n\n::: {.cell-output .cell-output-display execution_count=2}\n```{=tex}\n\\begin{tabular}{lrrrr}\n\\toprule\n{} &   PRCP &   m &        Pm &         Tr \\\\\nDATE       &        &     &           &            \\\\\n\\midrule\n2011-07-31 &   27.0 &   1 &  0.013158 &   1.013333 \\\\\n2002-07-31 &   28.5 &   2 &  0.026316 &   1.027027 \\\\\n2021-07-31 &   35.8 &   3 &  0.039474 &   1.041096 \\\\\n2001-07-31 &   38.6 &   4 &  0.052632 &   1.055556 \\\\\n2004-07-31 &   41.1 &   5 &  0.065789 &   1.070423 \\\\\n1998-07-31 &   41.3 &   6 &  0.078947 &   1.085714 \\\\\n1948-07-31 &   41.8 &   7 &  0.092105 &   1.101449 \\\\\n2019-07-31 &   42.3 &   8 &  0.105263 &   1.117647 \\\\\n2018-07-31 &   44.6 &   9 &  0.118421 &   1.134328 \\\\\n1965-07-31 &   45.1 &  10 &  0.131579 &   1.151515 \\\\\n1995-07-31 &   45.2 &  11 &  0.144737 &   1.169231 \\\\\n2005-07-31 &   45.6 &  12 &  0.157895 &   1.187500 \\\\\n1970-07-31 &   46.4 &  13 &  0.171053 &   1.206349 \\\\\n1990-07-31 &   46.4 &  14 &  0.184211 &   1.225806 \\\\\n2000-07-31 &   46.4 &  15 &  0.197368 &   1.245902 \\\\\n1967-07-31 &   46.5 &  16 &  0.210526 &   1.266667 \\\\\n1962-07-31 &   47.7 &  17 &  0.223684 &   1.288136 \\\\\n1957-07-31 &   47.8 &  18 &  0.236842 &   1.310345 \\\\\n1988-07-31 &   48.9 &  19 &  0.250000 &   1.333333 \\\\\n2014-07-31 &   49.9 &  20 &  0.263158 &   1.357143 \\\\\n1958-07-31 &   50.2 &  21 &  0.276316 &   1.381818 \\\\\n1973-07-31 &   50.7 &  22 &  0.289474 &   1.407407 \\\\\n1956-07-31 &   51.0 &  23 &  0.302632 &   1.433962 \\\\\n1976-07-31 &   51.1 &  24 &  0.315789 &   1.461538 \\\\\n1983-07-31 &   51.4 &  25 &  0.328947 &   1.490196 \\\\\n1972-07-31 &   51.8 &  26 &  0.342105 &   1.520000 \\\\\n1979-07-31 &   52.3 &  27 &  0.355263 &   1.551020 \\\\\n1987-07-31 &   52.4 &  28 &  0.368421 &   1.583333 \\\\\n2006-07-31 &   52.6 &  29 &  0.381579 &   1.617021 \\\\\n1981-07-31 &   53.0 &  30 &  0.394737 &   1.652174 \\\\\n1959-07-31 &   53.0 &  31 &  0.407895 &   1.688889 \\\\\n2020-07-31 &   53.1 &  32 &  0.421053 &   1.727273 \\\\\n1996-07-31 &   53.5 &  33 &  0.434211 &   1.767442 \\\\\n1986-07-31 &   53.7 &  34 &  0.447368 &   1.809524 \\\\\n2009-07-31 &   55.4 &  35 &  0.460526 &   1.853659 \\\\\n1982-07-31 &   55.9 &  36 &  0.473684 &   1.900000 \\\\\n1994-07-31 &   56.0 &  37 &  0.486842 &   1.948718 \\\\\n1974-07-31 &   56.3 &  38 &  0.500000 &   2.000000 \\\\\n1947-07-31 &   57.6 &  39 &  0.513158 &   2.054054 \\\\\n2013-07-31 &   57.7 &  40 &  0.526316 &   2.111111 \\\\\n1949-07-31 &   58.8 &  41 &  0.539474 &   2.171429 \\\\\n1975-07-31 &   58.8 &  42 &  0.552632 &   2.235294 \\\\\n1963-07-31 &   58.8 &  43 &  0.565789 &   2.303030 \\\\\n1969-07-31 &   59.0 &  44 &  0.578947 &   2.375000 \\\\\n1953-07-31 &   59.8 &  45 &  0.592105 &   2.451613 \\\\\n1980-07-31 &   61.6 &  46 &  0.605263 &   2.533333 \\\\\n1951-07-31 &   61.7 &  47 &  0.618421 &   2.620690 \\\\\n1950-07-31 &   61.8 &  48 &  0.631579 &   2.714286 \\\\\n1978-07-31 &   62.4 &  49 &  0.644737 &   2.814815 \\\\\n2003-07-31 &   62.6 &  50 &  0.657895 &   2.923077 \\\\\n1971-07-31 &   63.7 &  51 &  0.671053 &   3.040000 \\\\\n1955-07-31 &   64.5 &  52 &  0.684211 &   3.166667 \\\\\n2017-07-31 &   65.6 &  53 &  0.697368 &   3.304348 \\\\\n1999-07-31 &   65.7 &  54 &  0.710526 &   3.454545 \\\\\n1985-07-31 &   67.3 &  55 &  0.723684 &   3.619048 \\\\\n1966-07-31 &   67.4 &  56 &  0.736842 &   3.800000 \\\\\n1997-07-31 &   67.7 &  57 &  0.750000 &   4.000000 \\\\\n1968-07-31 &   68.0 &  58 &  0.763158 &   4.222222 \\\\\n1992-07-31 &   68.6 &  59 &  0.776316 &   4.470588 \\\\\n2016-07-31 &   79.8 &  60 &  0.789474 &   4.750000 \\\\\n2012-07-31 &   81.1 &  61 &  0.802632 &   5.066667 \\\\\n2015-07-31 &   82.1 &  62 &  0.815789 &   5.428571 \\\\\n1952-07-31 &   82.6 &  63 &  0.828947 &   5.846154 \\\\\n1991-07-31 &   83.8 &  64 &  0.842105 &   6.333333 \\\\\n1993-07-31 &   84.6 &  65 &  0.855263 &   6.909091 \\\\\n2007-07-31 &   85.2 &  66 &  0.868421 &   7.600000 \\\\\n1961-07-31 &   87.3 &  67 &  0.881579 &   8.444444 \\\\\n1989-07-31 &   92.4 &  68 &  0.894737 &   9.500000 \\\\\n2008-07-31 &   92.5 &  69 &  0.907895 &  10.857143 \\\\\n1977-07-31 &  100.2 &  70 &  0.921053 &  12.666667 \\\\\n2010-07-31 &  108.1 &  71 &  0.934211 &  15.200000 \\\\\n1960-07-31 &  137.2 &  72 &  0.947368 &  19.000000 \\\\\n1964-07-31 &  143.5 &  73 &  0.960526 &  25.333333 \\\\\n1954-07-31 &  172.6 &  74 &  0.973684 &  38.000000 \\\\\n1984-07-31 &  252.6 &  75 &  0.986842 &  76.000000 \\\\\n\\bottomrule\n\\end{tabular}\n```\n:::\n:::\n\n\nHow well does $P_m$ approximate $F(x)$?\n\n![](/archive/figures/weibull_plotting_position.png)\n\nWe can now see in this graph how long it takes, **on average**, for an annual maximum event above any threshold.\n\n![](/archive/figures/annual_max_vs_return_period.png)\n\nFor times longer than $n$, we need to extrapolate from the curve above.\n\n![](/archive/figures/extrapolation_exceedance1.png)\n\n![](/archive/figures/extrapolation_exceedance2.png)\n\n![](/archive/figures/extrapolation_exceedance3.png)\n\n![](/archive/figures/extrapolation_exceedance4.png)\n\n",
    "supporting": [
      "return-period-lecture_files/figure-pdf"
    ],
    "filters": []
  }
}